version: "3.9"

services:
  machine:
    image: cartesi/dapp:${DAPP_NAME:?undefined DAPP_NAME}-devel-machine
    command: xxd -c 256 -p latest/hash; sleep 3
    volumes:
      - machine:/var/opt/cartesi/machine-snapshots

  deployer:
    image: cartesi/rollups-cli:0.9.0
    depends_on:
      machine:
        condition: service_started
    command:
      [
        "create",
        "--rpc",
        "${HARDHAT_RPC_URL:?undefined _HARDHAT_RPC_URL}",
        "--deploymentFile",
        "/localhost/localhost.json",
        "--mnemonic",
        "${HARDHAT_MNEMONIC_PHRASE:?undefined HARDHAT_MNEMONIC_PHRASE}",
        "--templateHashFile",
        "/var/opt/cartesi/machine-snapshots/0_0/hash",
        "--outputFile",
        "/deployments/localhost/dapp.json"
      ]
    volumes:
      - machine:/var/opt/cartesi/machine-snapshots:ro
      - ./deployments:/deployments
      - ./localhost:/localhost

volumes:
  machine: {}
